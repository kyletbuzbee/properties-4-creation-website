name: Quality Gates

on:
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'

jobs:
  quality-gate:
    name: Comprehensive Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Run unit tests with coverage
      run: npm run test:coverage
      
    - name: Check coverage thresholds
      run: |
        # Check if coverage meets minimum requirements
        COVERAGE_FILE="./coverage/coverage-summary.json"
        if [ -f "$COVERAGE_FILE" ]; then
          echo "Coverage file found, checking thresholds..."
          # This would typically be handled by Jest config, but we can add additional checks here
        else
          echo "Coverage file not found, running coverage check..."
          npm run test:coverage
        fi
        
    - name: Build project
      run: npm run build
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Start local server
      run: |
        npm install -g serve
        serve -s dist -l 3000 &
        sleep 5
        
    - name: Run E2E tests
      run: npm run test:e2e
      
    - name: Run accessibility tests
      run: npm run test:accessibility
      
    - name: Run performance tests
      run: npm run test:performance
      
    - name: Security audit
      run: npm run security:audit
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          coverage/
          test-results/
          playwright-report/
          reports/
        retention-days: 7
        
    - name: Quality Gate Summary
      run: |
        echo "## Quality Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Linting passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Unit tests passed with coverage" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Build successful" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ E2E tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Accessibility tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Performance tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Security audit passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All quality gates have been met successfully!" >> $GITHUB_STEP_SUMMARY